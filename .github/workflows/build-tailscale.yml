name: Build and Release Tailscale for macOS ARM

on:
  workflow_dispatch:
  schedule:
    - cron: '0 1 * * *'

jobs:
  check-and-build:
    runs-on: macos-latest
    permissions:
      contents: write # å¿…é¡»ï¼šæˆäºˆåˆ›å»º Release çš„æƒé™

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Get latest Tailscale version
        id: versions
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # 1. è·å– Tailscale å®˜æ–¹æœ€æ–°ç‰ˆæœ¬
          echo "Fetching upstream version..."
          LATEST_RESP=$(curl -s -H "Authorization: token $GH_TOKEN" https://api.github.com/repos/tailscale/tailscale/releases/latest)
          LATEST_VERSION=$(echo "$LATEST_RESP" | jq -r '.tag_name // empty')
          
          if [ -z "$LATEST_VERSION" ]; then
            echo "Error: Could not fetch upstream version."
            exit 1
          fi
          echo "Upstream Latest: $LATEST_VERSION"

          # 2. è·å–å½“å‰ä»“åº“æœ€æ–°ç‰ˆæœ¬ (å®¹é”™å¤„ç†ï¼šå¦‚æœæ˜¯ 404 æˆ–æ—  releaseï¼Œè§†ä¸º 0.0.0)
          echo "Fetching current repo version..."
          CURRENT_RESP=$(curl -s -o /dev/null -w "%{http_code}" -H "Authorization: token $GH_TOKEN" https://api.github.com/repos/${{ github.repository }}/releases/latest)
          
          if [ "$CURRENT_RESP" == "200" ]; then
             CURRENT_JSON=$(curl -s -H "Authorization: token $GH_TOKEN" https://api.github.com/repos/${{ github.repository }}/releases/latest)
             CURRENT_VERSION=$(echo "$CURRENT_JSON" | jq -r '.tag_name')
          else
             echo "No release found in current repo (HTTP $CURRENT_RESP). Defaulting to 0.0.0"
             CURRENT_VERSION="v0.0.0"
          fi
          echo "Current Repo Version: $CURRENT_VERSION"

          # 3. æ¯”è¾ƒç‰ˆæœ¬ (å»é‡ v å‰ç¼€)
          ver_remote=$(echo "$LATEST_VERSION" | sed 's/^v//')
          ver_local=$(echo "$CURRENT_VERSION" | sed 's/^v//')

          # ä½¿ç”¨ sort -V æ¯”è¾ƒï¼Œå¦‚æœ remote > localï¼Œåˆ™éœ€è¦æ„å»º
          if [ "$(echo -e "$ver_local\n$ver_remote" | sort -V | tail -n1)" == "$ver_remote" ] && [ "$ver_local" != "$ver_remote" ]; then
            echo "New version detected!"
            echo "build=true" >> $GITHUB_OUTPUT
            echo "version=$LATEST_VERSION" >> $GITHUB_OUTPUT
          else
            echo "Up to date."
            echo "build=false" >> $GITHUB_OUTPUT
          fi

      - name: Set up Go
        if: steps.versions.outputs.build == 'true'
        uses: actions/setup-go@v5
        with:
          go-version: '1.22' # å»ºè®®å‡çº§åˆ°è¾ƒæ–°ç‰ˆæœ¬
          cache: false

      - name: Compile Tailscale
        if: steps.versions.outputs.build == 'true'
        env:
          TARGET_VERSION: ${{ steps.versions.outputs.version }}
        run: |
          echo "Building $TARGET_VERSION..."
          export GOOS=darwin
          export GOARCH=arm64
          # macos-latest ç›®å‰é€šå¸¸æ˜¯ ARMï¼Œä½†æ˜¾å¼å¼€å¯ CGO æ›´å¥½ï¼Œå¦‚æœæ˜¯åœ¨ Intel ä¸Šåˆ™éœ€æ³¨æ„ç¯å¢ƒ
          # å¯¹äºç®€å•çš„ tailscale buildï¼Œé€šå¸¸ä¿æŒé»˜è®¤å³å¯ï¼Œæˆ–è€…æ˜¾å¼ CGO_ENABLED=0 (çº¯ Go)
          # å¦‚æœéœ€è¦ CGO (å¦‚ mac ç³»ç»Ÿé›†æˆ)ï¼Œå»ºè®®ä¸å¼ºåˆ¶è®¾ç½® CGO_ENABLED=0
          
          go install tailscale.com/cmd/tailscale{,d}@$TARGET_VERSION
          
          mkdir -p dist
          cp $(go env GOPATH)/bin/tailscale dist/
          cp $(go env GOPATH)/bin/tailscaled dist/
          
          # éªŒè¯æ–‡ä»¶æ˜¯å¦å­˜åœ¨
          ls -lh dist/

      - name: Create Release and Upload Assets
        if: steps.versions.outputs.build == 'true'
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ steps.versions.outputs.version }}
          name: ${{ steps.versions.outputs.version }}
          body: |
            Tailscale binaries for macOS ARM (Apple Silicon).
            Upstream Version: ${{ steps.versions.outputs.version }}
            Built automatically by GitHub Actions.
          draft: false
          prerelease: false
          files: |
            dist/tailscale
            dist/tailscaled
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Send Telegram notification
        if: steps.versions.outputs.build == 'true'
        run: |
          MSG="New Tailscale release for macOS ARM! ğŸš€%0AVersion: ${{ steps.versions.outputs.version }}"
          curl -s -X POST https://api.telegram.org/bot${{ secrets.TELEGRAM_BOT_TOKEN }}/sendMessage \
            -d chat_id=${{ secrets.TELEGRAM_CHAT_ID }} \
            -d text="$MSG"

  cleanup-runs:
    runs-on: ubuntu-latest
    needs: check-and-build
    permissions:
      actions: write
      contents: read
    steps:
      - name: Delete old workflow runs
        uses: Mattraks/delete-workflow-runs@v2
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          repository: ${{ github.repository }}
          retain_days: 7
          keep_minimum_runs: 6
